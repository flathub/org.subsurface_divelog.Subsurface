app-id: org.subsurface_divelog.Subsurface
sdk: org.kde.Sdk
runtime: org.kde.Platform
runtime-version: '5.15'
base: io.qt.qtwebkit.BaseApp
base-version: '5.15'
command: subsurface
rename-icon: subsurface-icon
rename-appdata-file: subsurface.appdata.xml
rename-desktop-file: subsurface.desktop
finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --share=network
  - --device=all # required to talk to dive computers
  - --system-talk-name=org.bluez # required to talk to dive computers
  - --filesystem=xdg-config/kdeglobals:ro # gives application access to kdeglobals
  - --talk-name=com.canonical.AppMenu.Registrar # required for global menu
cleanup-commands:
  - /app/cleanup-BaseApp.sh
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/doc
  - /share/man
  - /src
  - '*.a'
  - '*.la'
modules:
  - shared-modules/libusb/libusb.json

  - name: libical
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBUILD_SHARED_LIBS:BOOL=ON
      - -DICAL_GLIB=true
      - -DGOBJECT_INTROSPECTION=true
      - -DICAL_GLIB_VAPI=true
      - -DICAL_BUILD_DOCS=false
      - -DICAL_GLIB_VAPI=False
    sources:
      - type: archive
        url: https://github.com/libical/libical/archive/v3.0.14.tar.gz
        sha256: 4284b780356f1dc6a01f16083e7b836e63d3815e27ed0eaaad684712357ccc8f
        x-checker-data:
          type: anitya
          project-id: 1637
          url-template: https://github.com/libical/libical/archive/v$version.tar.gz

  - name: libssh2
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_C_FLAGS=-fPIC
    sources:
      - type: archive
        url: https://github.com/libssh2/libssh2/archive/libssh2-1.10.0.tar.gz
        sha256: 31469ccfc71a5247c926e3f0938e122cbb7a7a4a1bdf1cf2d3121f78b558d261
        x-checker-data:
          type: anitya
          project-id: 1730
          url-template: https://github.com/libssh2/libssh2/archive/libssh2-$version.tar.gz

  - name: libzip
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    sources:
      - type: archive
        url: https://github.com/nih-at/libzip/archive/v1.9.0.tar.gz
        sha256: e6755f5fe67fcf92e6a2366e5a66c8c614b4d2d39fecd48cde8f9925eb03918a
        x-checker-data:
          type: anitya
          project-id: 10649
          url-template: https://github.com/nih-at/libzip/archive/v$version.tar.gz

  - name: grantlee
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    sources:
      - type: archive
        url: https://github.com/steveire/grantlee/archive/v5.2.0.tar.gz
        sha256: 139acee5746b957bdf1327ec0d97c604d4c0b9be42aec5d584297cb5ed6a990a
        x-checker-data:
          type: anitya
          project-id: 21448
          url-template: https://github.com/steveire/grantlee/archive/v$version.tar.gz

  - name: libgit2
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    sources:
      - type: archive
        url: https://github.com/libgit2/libgit2/archive/v1.4.3.tar.gz
        sha256: f48b961e463a9e4e7e7e58b21a0fb5a9b2a1d24d9ba4d15870a0c9b8ad965163
        x-checker-data:
          type: anitya
          project-id: 1627
          url-template: https://github.com/libgit2/libgit2/archive/v$version.tar.gz

  # flatpak-pip-generator docutils
  - python3-docutils.json

  - name: bluez
    config-opts:
      - --disable-datafiles
      - --disable-systemd
      - --enable-experimental
      - --enable-library
      - --disable-client
      - --disable-mesh
      - --disable-tools
      - --disable-monitor
      - --disable-udev
      - --prefix=/app
      - --sysconfdir=/app/etc
    sources:
      - type: archive
        url: http://www.kernel.org/pub/linux/bluetooth/bluez-5.64.tar.xz
        sha256: ae437e65b6b3070c198bc5b0109fe9cdeb9eaa387380e2072f9de65fe8a1de34
        x-checker-data:
          type: anitya
          project-id: 10029
          url-template: http://www.kernel.org/pub/linux/bluetooth/bluez-$version.tar.xz

  - name: qtconnectivity
    buildsystem: simple
    cleanup-platform:
      - /bin
      - /mkspecs
    sources:
    # When using the archive instead of git, the build fails with the following error
    # In file included from qlowenergycontroller.cpp:52:
    # bluez/bluez5_helper_p.h:57:10: fatal error: QtBluetooth/private/qtbluetoothglobal_p.h: No such file or directory
    #    57 | #include <QtBluetooth/private/qtbluetoothglobal_p.h>
    #       |          ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      - type: git
        url: https://github.com/qt/qtconnectivity
        tag: v5.15.4-lts-lgpl
        commit: 83ca3a2471560f09d723157322adc0b5c33ed914
        x-checker-data:
          type: anitya
          project-id: 153467
          tag-template: v$version
          stable-only: true
          versions:
            <: '6'

    build-commands:
      - qmake
      - make -j $FLATPAK_BUILDER_N_JOBS
      - cp -r -n {bin,include,lib} /app
      - mkdir -p /app/src/bluetooth
      - cp -r src/bluetooth /app/src/ # header files required by subsurface

  - name: googlemaps
    buildsystem: qmake
    sources:
      - type: git
        url: https://github.com/subsurface/googlemaps
      - type: shell
        commands:
          - sed -i "s|\$\$\[QT_INSTALL_PLUGINS\]|/app/lib/plugins|" googlemaps.pro

  - name: libconfuse # build dependency of libftdi
    sources:
      - type: archive
        url: https://github.com/libconfuse/libconfuse/archive/v3.3.tar.gz
        sha256: cb90c06f2dbec971792af576d5b9a382fb3c4ca2b1deea55ea262b403f4e641e
        x-checker-data:
          type: anitya
          project-id: 1581
          url-template: https://github.com/libconfuse/libconfuse/archive/v$version.tar.gz

  - name: libftdi
    buildsystem: cmake-ninja
    config-opts:
      - -DLIB_SUFFIX=
      - -Wno-dev # suppress warning for project developers
    sources:
      - type: archive
        url: https://www.intra2net.com/en/developer/libftdi/download/libftdi1-1.5.tar.bz2
        sha256: 7c7091e9c86196148bd41177b4590dccb1510bfe6cea5bf7407ff194482eb049
        x-checker-data:
          type: anitya
          project-id: 14622
          url-template: https://www.intra2net.com/en/developer/libftdi/download/libftdi1-$version.tar.bz2

  - name: libdc
    sources:
      - type: archive
        url: https://github.com/subsurface/libdc/archive/v5.0.8.tar.gz
        sha256: 430be06204562189e55e2dfbf63fe3c08019c122eba81c9530aec2372ff9423a
        x-checker-data:
          type: anitya
          project-id: 153474
          url-template: https://github.com/subsurface/libdc/archive/v$version.tar.gz
      - type: shell
        commands:
          - autoreconf --install

  - name: subsurface
    buildsystem: cmake
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DFTDISUPPORT=ON
      - -DQt5WebKitWidgets_DIR=/app/lib/cmake/Qt5WebKitWidgets
    sources:
      - type: git # use git in order to make HandleVersionGeneration.cmake work
        url: https://github.com/subsurface/subsurface
        tag: v5.0.8
        commit: f1c1e0ccee0b8181b6a0c0782f1c83063bd55921
        x-checker-data:
          type: anitya
          project-id: 4903
          tag-template: v$version
      - type: shell
        commands:
          - sed -e "s|setDesktopFileName(\"subsurface\")|setDesktopFileName(\"org.subsurface_divelog.Subsurface\")|"
            -i core/qt-init.cpp
          - sed -e "s|<id>subsurface</id>|<id>org.subsurface_divelog.Subsurface</id>|"
            -i appdata/subsurface.appdata.xml.in
    # copied from
    # https://github.com/texstudio-org/texstudio/blob/master/.github/workflows/ci.yml (setting QT_QPA_PLATFORM) and
    # https://github.com/subsurface/subsurface/blob/master/README_TESTING.md
    build-commands:
      - cd tests && QT_QPA_PLATFORM=offscreen ctest # if tests fail, use -V option to get verbose output
